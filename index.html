<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>蔵書管理アプリ（バーコード読み取り＋CSV入出力）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quagga（フォールバック用） -->
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <style>
    #interactive {
      position: relative;
    }
    #interactive video,
    #interactive canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    #interactive .drawingBuffer {
      display: none !important;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">
        蔵書管理アプリ
      </h1>
      <p class="text-sm text-slate-600">
        バーコードを読み取り、書籍情報を登録・CSV入出力します。
      </p>
    </header>

    <!-- カメラ & 最新情報 -->
    <section class="mb-6">
      <div class="grid md:grid-cols-[280px,1fr] gap-4">
        <!-- カメラ -->
        <div>
          <h2 class="font-semibold mb-2">カメラ</h2>
          <div id="interactive"
               class="w-full h-48 bg-black/80 rounded-lg overflow-hidden
                      flex items-center justify-center text-slate-200 text-sm">
            カメラ停止中
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="startCameraBtn"
              class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold">
              カメラ起動
            </button>
            <button id="stopCameraBtn"
              class="px-4 py-2 rounded-lg bg-slate-500 text-white text-sm font-semibold">
              カメラ停止
            </button>
          </div>
          <p id="statusMessage" class="mt-2 text-xs text-slate-600">
            準備完了：カメラ起動ボタンを押してください。（必ず HTTPS または localhost で開いてください）
          </p>
        </div>

        <!-- 最新読み取り結果 -->
        <div>
          <h2 class="font-semibold mb-2">読み取り情報</h2>
          <div class="bg-white rounded-xl border p-4 space-y-2">
            <p class="text-sm">
              読み取ったコード：<span id="lastRaw" class="font-mono"></span>
            </p>
            <p class="text-sm">
              使用する数値コード：<span id="lastIsbn" class="font-mono"></span>
            </p>
            <p class="text-sm">
              タイトル：<span id="lastTitle"></span>
            </p>
            <p class="text-sm">
              著者：<span id="lastAuthors"></span>
            </p>
            <p class="text-xs text-slate-500">
              ※ 同じコードは重複して登録されません。
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- 書籍リスト ＋ CSV入出力 -->
    <section>
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-3">
        <h2 class="font-semibold">登録済みの書籍リスト</h2>

        <div class="flex flex-wrap gap-2">
          <button id="exportBtn"
            class="px-3 py-1.5 rounded-lg border border-sky-300 text-sky-700 text-xs font-semibold bg-sky-50">
            エクスポート（CSV）
          </button>

          <label
            class="px-3 py-1.5 rounded-lg border border-emerald-300 text-emerald-700 text-xs font-semibold bg-emerald-50 cursor-pointer">
            インポート（CSV）
            <input id="importInput" type="file" accept=".csv,text/csv"
                   class="hidden" />
          </label>

          <button id="clearAllBtn"
            class="px-3 py-1.5 rounded-lg border border-rose-200 text-rose-600 text-xs font-semibold">
            すべて削除
          </button>
        </div>
      </div>

      <div id="booksList" class="space-y-3"></div>

      <p id="emptyMessage" class="text-sm text-slate-500 mt-3">
        まだ書籍が登録されていません。
      </p>
    </section>
  </div>

  <script>
    // ====== グローバル状態 ======
    var STORAGE_KEY = "isbnBookList";
    var books = [];

    var isCameraRunning = false;
    var lastScanTime = 0;
    var lastScanCode = null;

    var currentStream = null;
    var currentVideoEl = null;
    var scanCanvas = null;
    var scanContext = null;
    var scanTimerId = null;

    var statusMessage = document.getElementById("statusMessage");
    var lastRawEl = document.getElementById("lastRaw");
    var lastIsbnEl = document.getElementById("lastIsbn");
    var lastTitleEl = document.getElementById("lastTitle");
    var lastAuthorsEl = document.getElementById("lastAuthors");
    var booksListEl = document.getElementById("booksList");
    var emptyMessageEl = document.getElementById("emptyMessage");

    var barcodeDetector = null; // 標準API

    // ====== ローカルストレージ ======
    function loadBooks() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        books = raw ? JSON.parse(raw) : [];
      } catch (e) {
        books = [];
      }
      renderBooks();
    }

    function saveBooks() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    }

    function renderBooks() {
      booksListEl.innerHTML = "";
      if (!books.length) {
        emptyMessageEl.classList.remove("hidden");
        return;
      }
      emptyMessageEl.classList.add("hidden");

      for (var i = 0; i < books.length; i++) {
        (function(index) {
          var b = books[index];
          var item = document.createElement("div");
          item.className =
            "bg-white border border-slate-200 rounded-xl p-4 flex justify-between items-start gap-4";

          var info = document.createElement("div");
          info.innerHTML =
            '<div class="font-semibold text-sm md:text-base">' +
              b.title +
            '</div>' +
            '<div class="text-xs md:text-sm text-slate-600">著者：' +
              b.authors +
            '</div>' +
            '<div class="text-xs text-slate-500 font-mono mt-1">コード：' +
              b.isbn +
            '</div>';

          var delBtn = document.createElement("button");
          delBtn.className =
            "px-3 py-1 rounded-md bg-rose-50 text-rose-600 text-xs font-semibold border border-rose-200";
          delBtn.textContent = "削除";
          delBtn.onclick = function() {
            if (confirm("この書籍を削除しますか？")) {
              books.splice(index, 1);
              saveBooks();
              renderBooks();
            }
          };

          item.appendChild(info);
          item.appendChild(delBtn);
          booksListEl.appendChild(item);
        })(i);
      }
    }

    // ====== 書籍情報取得 ======
    function fetchBookByIsbn(isbn) {
      return fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:" + isbn)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var v = (data.items && data.items[0] && data.items[0].volumeInfo) || {};
          var title = v.title || "(タイトル不明)";
          var authors = v.authors || ["(著者不明)"];
          return {
            title: title,
            authors: authors.join(", ")
          };
        })["catch"](function() {
          return {
            title: "(タイトル不明)",
            authors: "(著者不明)"
          };
        });
    }

    function registerBook(isbn) {
      for (var i = 0; i < books.length; i++) {
        if (books[i].isbn === isbn) {
          statusMessage.textContent = "このコードはすでに登録されています。";
          lastIsbnEl.textContent = books[i].isbn;
          lastTitleEl.textContent = books[i].title;
          lastAuthorsEl.textContent = books[i].authors;
          return;
        }
      }

      statusMessage.textContent = "書籍情報を取得中…";

      fetchBookByIsbn(isbn).then(function(info) {
        var book = {
          isbn: isbn,
          title: info.title,
          authors: info.authors
        };
        books.unshift(book);
        saveBooks();
        renderBooks();

        lastIsbnEl.textContent = isbn;
        lastTitleEl.textContent = info.title;
        lastAuthorsEl.textContent = info.authors;
        statusMessage.textContent = "登録しました。";
      });
    }

    // ====== カメラ起動 ======
    function startCamera() {
      statusMessage.textContent = "カメラ起動処理を開始します…";

      if (isCameraRunning) {
        statusMessage.textContent = "すでにカメラは起動中です。";
        return;
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusMessage.textContent =
          "このブラウザは getUserMedia に対応していません。";
        return;
      }

      var target = document.getElementById("interactive");
      target.innerHTML = "";

      var video = document.createElement("video");
      video.setAttribute("autoplay", "true");
      video.setAttribute("playsinline", "true");
      video.setAttribute("muted", "true");
      video.className = "w-full h-full object-cover";
      currentVideoEl = video;
      target.appendChild(video);

      var constraints = {
        video: { facingMode: { ideal: "environment" } },
        audio: false
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
          currentStream = stream;
          video.srcObject = stream;
          video.onloadedmetadata = function() {
            video.play();
          };
          isCameraRunning = true;
          statusMessage.textContent =
            "カメラ起動しました。バーコードを中央にかざしてください。";

          startScanningLoop(video);
        })
        ["catch"](function(err) {
          console.error("getUserMedia error:", err);
          statusMessage.textContent =
            "カメラ起動に失敗しました（" + err.name +
            "）。HTTPS または localhost / カメラ権限を確認してください。";
          isCameraRunning = false;
          currentStream = null;
          currentVideoEl = null;
          target.innerHTML = "カメラ停止中";
        });
    }

    // ====== スキャンループ ======
    function startScanningLoop(video) {
      if (!scanCanvas) {
        scanCanvas = document.createElement("canvas");
        scanContext = scanCanvas.getContext("2d");
      }
      if (scanTimerId) {
        clearInterval(scanTimerId);
      }

      scanTimerId = setInterval(function() {
        if (!isCameraRunning) return;
        if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;

        var w = video.videoWidth;
        var h = video.videoHeight;
        if (!w || !h) return;

        var maxW = 800;
        var scale = (w > maxW) ? maxW / w : 1;
        var dw = Math.floor(w * scale);
        var dh = Math.floor(h * scale);

        scanCanvas.width = dw;
        scanCanvas.height = dh;
        scanContext.drawImage(video, 0, 0, dw, dh);

        if (barcodeDetector) {
          barcodeDetector.detect(scanCanvas)
            .then(function(barcodes) {
              if (!barcodes || !barcodes.length) return;
              var raw = barcodes[0].rawValue || "";
              if (!raw) return;
              onBarcodeDetected(String(raw));
            })
            ["catch"](function(err) {
              console.warn("BarcodeDetector error:", err);
            });
          return;
        }

        if (typeof Quagga === "undefined") return;

        Quagga.decodeSingle({
          src: scanCanvas,
          numOfWorkers: 0,
          inputStream: {
            size: 640,
            singleChannel: true
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          decoder: {
            readers: ["ean_reader", "ean_13_reader"]
          },
          locate: true
        }, function(result) {
          if (!result || !result.codeResult || !result.codeResult.code) {
            return;
          }
          var code = result.codeResult.code;
          onBarcodeDetected(code);
        });
      }, 500);
    }

    // ====== カメラ停止 ======
    function stopCamera() {
      statusMessage.textContent = "カメラ停止処理を実行します…";

      if (!isCameraRunning && !currentStream && !currentVideoEl) {
        statusMessage.textContent = "カメラはすでに停止しています。";
        return;
      }

      if (scanTimerId) {
        clearInterval(scanTimerId);
        scanTimerId = null;
      }

      if (currentStream && currentStream.getTracks) {
        try {
          var tracks = currentStream.getTracks();
          for (var i = 0; i < tracks.length; i++) {
            tracks[i].stop();
          }
        } catch (e2) {
          console.warn("currentStream.stop error:", e2);
        }
        currentStream = null;
      }

      if (currentVideoEl) {
        try { currentVideoEl.pause(); } catch (e3) {}
        try {
          if (currentVideoEl.srcObject && currentVideoEl.srcObject.getTracks) {
            var vTracks = currentVideoEl.srcObject.getTracks();
            for (var j = 0; j < vTracks.length; j++) {
              vTracks[j].stop();
            }
          }
        } catch (e4) {}
        currentVideoEl.srcObject = null;
        var parent = currentVideoEl.parentNode;
        if (parent) parent.removeChild(currentVideoEl);
        currentVideoEl = null;
      }

      var target = document.getElementById("interactive");
      target.innerHTML = "カメラ停止中";

      isCameraRunning = false;
      statusMessage.textContent = "カメラを停止しました。";
    }

    // ====== バーコード検出（ISBNチェック撤廃） ======
    function onBarcodeDetected(code) {
      var now = Date.now();
      if (code === lastScanCode && now - lastScanTime < 2000) {
        return;
      }
      lastScanCode = code;
      lastScanTime = now;

      var cleaned = (code || "").replace(/[^0-9]/g, "");

      lastRawEl.textContent = code + "（長さ " + code.length + "）";
      lastIsbnEl.textContent = cleaned + "（数字だけ・長さ " + cleaned.length + "）";

      if (!cleaned) {
        statusMessage.textContent =
          "バーコードは読み取りましたが、数字が含まれていないため登録できません。";
        return;
      }

      statusMessage.textContent =
        "バーコード検出：数値コード " + cleaned + " を登録候補として処理します…";

      registerBook(cleaned);
    }

    // ====== CSV エクスポート ======
    function toCsvField(value) {
      if (value === null || value === undefined) return "";
      var s = String(value);
      if (s.indexOf('"') >= 0 || s.indexOf(",") >= 0 || s.indexOf("\n") >= 0 || s.indexOf("\r") >= 0) {
        s = '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    function exportBooksToCsv() {
      if (!books.length) {
        statusMessage.textContent = "エクスポートするデータがありません。";
        return;
      }

      var lines = [];
      // ヘッダ
      lines.push(["code", "title", "authors"].map(toCsvField).join(","));

      for (var i = 0; i < books.length; i++) {
        var b = books[i];
        var row = [
          toCsvField(b.isbn),
          toCsvField(b.title),
          toCsvField(b.authors)
        ];
        lines.push(row.join(","));
      }

      var csv = lines.join("\r\n");
      // 日本語Excel対策でBOM付きUTF-8にする
      var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      var blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      var now = new Date();
      var y = now.getFullYear();
      var m = ("0" + (now.getMonth() + 1)).slice(-2);
      var d = ("0" + now.getDate()).slice(-2);
      a.download = "books_" + y + m + d + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      statusMessage.textContent = "CSVファイルをエクスポートしました。";
    }

    // ====== CSV インポート ======
    function parseCsvLine(line) {
      var result = [];
      var current = "";
      var inQuotes = false;
      for (var i = 0; i < line.length; i++) {
        var ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            current += ch;
          }
        } else {
          if (ch === '"') {
            inQuotes = true;
          } else if (ch === ",") {
            result.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
      }
      result.push(current);
      return result;
    }

    function importBooksFromCsv(text) {
      var lines = text.split(/\r?\n/);
      var importedCount = 0;
      if (!lines.length) return 0;

      // 1行目がヘッダらしき場合は飛ばす
      var startIndex = 0;
      if (lines[0].toLowerCase().indexOf("code") !== -1 ||
          lines[0].toLowerCase().indexOf("isbn") !== -1) {
        startIndex = 1;
      }

      for (var i = startIndex; i < lines.length; i++) {
        var line = lines[i];
        if (!line.trim()) continue;

        var cols = parseCsvLine(line);
        var code = (cols[0] || "").trim();
        var title = (cols[1] || "").trim();
        var authors = (cols[2] || "").trim();

        if (!code) continue;

        var exists = false;
        for (var j = 0; j < books.length; j++) {
          if (books[j].isbn === code) {
            exists = true;
            break;
          }
        }
        if (exists) continue;

        var book = {
          isbn: code,
          title: title || "(タイトル不明)",
          authors: authors || "(著者不明)"
        };
        books.unshift(book);
        importedCount++;
      }

      if (importedCount > 0) {
        saveBooks();
        renderBooks();
      }
      return importedCount;
    }

    function handleImportFile(file) {
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result || "";
        var count = importBooksFromCsv(text);
        statusMessage.textContent =
          "CSVインポート完了：" + count + " 件の書籍を追加しました。";
      };
      reader.onerror = function() {
        statusMessage.textContent = "CSVの読み込み中にエラーが発生しました。";
      };
      reader.readAsText(file, "UTF-8");
    }

    // ====== イベント登録 ======
    document.getElementById("startCameraBtn").addEventListener("click", startCamera);
    document.getElementById("stopCameraBtn").addEventListener("click", stopCamera);

    document.getElementById("clearAllBtn").addEventListener("click", function() {
      if (!books.length) return;
      if (confirm("すべての書籍情報を削除しますか？")) {
        books = [];
        saveBooks();
        renderBooks();
        lastRawEl.textContent = "";
        lastIsbnEl.textContent = "";
        lastTitleEl.textContent = "";
        lastAuthorsEl.textContent = "";
        statusMessage.textContent = "すべて削除しました。";
      }
    });

    document.getElementById("exportBtn").addEventListener("click", function() {
      exportBooksToCsv();
    });

    document.getElementById("importInput").addEventListener("change", function(e) {
      var file = e.target.files[0];
      if (!file) return;
      handleImportFile(file);
      // 同じファイルを連続で選んだときも change が発火するようリセット
      e.target.value = "";
    });

    // ====== 初期化 ======
    window.addEventListener("DOMContentLoaded", function() {
      loadBooks();

      if ("BarcodeDetector" in window) {
        try {
          barcodeDetector = new BarcodeDetector({
            formats: ["ean_13", "ean_8", "code_128", "upc_a", "upc_e"]
          });
          statusMessage.textContent =
            "準備完了：カメラ起動ボタンを押してください。（BarcodeDetector 対応）";
        } catch (e) {
          barcodeDetector = null;
          statusMessage.textContent =
            "準備完了：カメラ起動ボタンを押してください。（フォールバック: Quagga）";
        }
      } else {
        statusMessage.textContent =
          "準備完了：カメラ起動ボタンを押してください。（BarcodeDetector なし／Quagga使用）";
      }
    });
  </script>
</body>
</html>
