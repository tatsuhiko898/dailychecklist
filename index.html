<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>蔵書管理アプリ（バーコード読み取り＋CSV入出力）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quagga（フォールバック用） -->
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <style>
    #interactive {
      position: relative;
    }
    #interactive video,
    #interactive canvas {
      width: 100% !important;
      height: auto !important;
      object-fit: contain;
      display: block;
    }
    #interactive .drawingBuffer {
      display: none !important;
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-6 md:py-10">
    <header class="mb-6 md:mb-8">
      <h1 class="text-xl md:text-2xl font-bold text-slate-800">
        蔵書管理アプリ
      </h1>
      <p class="text-xs md:text-sm text-slate-600 mt-2">
        カメラでバーコード（ISBN）を読み取って、本の情報を登録できます。<br />
        また、CSVファイルでのインポート／エクスポートにも対応しています。
      </p>
    </header>

    <!-- カメラ & 最新情報 -->
    <section class="mb-6">
      <div class="grid md:grid-cols-[280px,1fr] gap-4">
        <!-- カメラ -->
        <div>
          <h2 class="font-semibold mb-2">カメラ</h2>
          <div id="interactive"
               class="w-full bg-black/80 rounded-lg overflow-hidden
                      flex items-center justify-center text-slate-200 text-sm">
            カメラ停止中
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="startCameraBtn"
              class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold">
              カメラ起動
            </button>
            <button id="stopCameraBtn"
              class="px-4 py-2 rounded-lg bg-slate-300 text-slate-900 text-sm font-semibold">
              カメラ停止
            </button>
          </div>
        </div>

        <!-- 最新の読み取り結果 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-slate-200">
          <h2 class="font-semibold mb-2">最新の読み取り結果</h2>
          <dl class="text-sm space-y-2">
            <div>
              <dt class="text-slate-500 text-xs mb-1">コード</dt>
              <dd id="lastCode"
                  class="font-mono break-all bg-slate-50 rounded px-2 py-1 border border-slate-200">
                まだ読み取りは行われていません
              </dd>
            </div>
            <div>
              <dt class="text-slate-500 text-xs mb-1">タイトル</dt>
              <dd id="lastTitle"
                  class="bg-slate-50 rounded px-2 py-1 border border-slate-200">
                -
              </dd>
            </div>
            <div>
              <dt class="text-slate-500 text-xs mb-1">著者</dt>
              <dd id="lastAuthors"
                  class="bg-slate-50 rounded px-2 py-1 border border-slate-200">
                -
              </dd>
            </div>
          </dl>
          <p id="statusMessage" class="mt-3 text-xs text-slate-600">
            準備中…
          </p>
        </div>
      </div>
    </section>

    <!-- 手入力 & CSV -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- 手入力 -->
      <div class="bg-white rounded-lg shadow-sm p-4 border border-slate-200">
        <h2 class="font-semibold mb-2">ISBNコードの手入力</h2>
        <p class="text-xs text-slate-600 mb-2">
          カメラが使えない場合やバーコードがうまく読み取れない場合は、ISBNコードを手入力してください。
        </p>
        <div class="flex flex-col gap-2">
          <input
            id="manualIsbn"
            type="text"
            inputmode="numeric"
            placeholder="978から始まる13桁のISBN"
            class="w-full border border-slate-300 rounded px-2 py-1 text-sm font-mono"
          />
          <button id="manualAddBtn"
            class="px-4 py-2 rounded bg-emerald-600 text-white text-sm font-semibold">
            手入力で登録
          </button>
        </div>
      </div>

      <!-- CSV 入出力 -->
      <div class="bg-white rounded-lg shadow-sm p-4 border border-slate-200">
        <h2 class="font-semibold mb-2">CSV インポート / エクスポート</h2>
        <p class="text-xs text-slate-600 mb-3">
          書籍リストを CSV ファイルとしてエクスポート／インポートできます。
        </p>
        <div class="space-y-3 text-sm">
          <div>
            <button id="exportCsvBtn"
              class="px-4 py-2 rounded bg-sky-600 text-white text-sm font-semibold">
              CSVをエクスポート
            </button>
          </div>
          <div>
            <label class="inline-flex items-center gap-2">
              <span class="px-3 py-2 rounded bg-violet-600 text-white text-sm font-semibold cursor-pointer">
                CSVをインポート
              </span>
              <input id="importCsvInput" type="file" accept=".csv,text/csv" class="hidden" />
            </label>
          </div>
          <p class="text-xs text-slate-500">
            フォーマット：1行目に
            <code class="bg-slate-50 px-1 rounded border border-slate-200">code,title,authors</code>
            を記述し、2行目以降にデータ行を記述してください。
          </p>
        </div>
      </div>
    </section>

    <!-- 登録済み一覧 -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">登録済みの書籍一覧</h2>
        <button id="clearAllBtn"
          class="px-3 py-1 rounded border border-rose-300 text-rose-700 bg-rose-50 text-xs font-semibold">
          すべて削除
        </button>
      </div>
      <p id="emptyMessage" class="text-xs text-slate-500 mb-2">
        まだ書籍は登録されていません。
      </p>
      <div id="booksList" class="space-y-2 text-sm"></div>
    </section>
  </div>

  <script>
    // ====== DOM参照 ======
    var interactiveEl   = document.getElementById("interactive");
    var startCameraBtn  = document.getElementById("startCameraBtn");
    var stopCameraBtn   = document.getElementById("stopCameraBtn");
    var statusMessage   = document.getElementById("statusMessage");
    var lastCodeEl      = document.getElementById("lastCode");
    var lastTitleEl     = document.getElementById("lastTitle");
    var lastAuthorsEl   = document.getElementById("lastAuthors");

    var manualIsbnInput = document.getElementById("manualIsbn");
    var manualAddBtn    = document.getElementById("manualAddBtn");

    var exportCsvBtn    = document.getElementById("exportCsvBtn");
    var importCsvInput  = document.getElementById("importCsvInput");

    var booksListEl     = document.getElementById("booksList");
    var emptyMessageEl  = document.getElementById("emptyMessage");
    var clearAllBtn     = document.getElementById("clearAllBtn");

    // ====== 書籍リスト管理 ======
    var STORAGE_KEY = "isbnBookList";
    var books = [];

    function loadBooks() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          books = [];
          return;
        }
        var parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          books = parsed;
        } else {
          books = [];
        }
      } catch (e) {
        console.error("loadBooks error:", e);
        books = [];
      }
    }

    function saveBooks() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    }

    function renderBooks() {
      booksListEl.innerHTML = "";
      if (!books.length) {
        emptyMessageEl.classList.remove("hidden");
        return;
      }
      emptyMessageEl.classList.add("hidden");

      books.forEach(function(book, index) {
        var item = document.createElement("div");
        item.className =
          "bg-white border border-slate-200 rounded p-3 flex justify-between items-start gap-3";

        var info = document.createElement("div");
        info.innerHTML =
          '<div class="font-semibold text-sm md:text-base">' +
            book.title +
          '</div>' +
          '<div class="text-xs text-slate-600">著者：' +
            book.authors +
          '</div>' +
          '<div class="text-xs text-slate-500 font-mono mt-1">コード：' +
            book.isbn +
          '</div>';

        var delBtn = document.createElement("button");
        delBtn.className =
          "px-3 py-1 rounded bg-rose-50 text-rose-700 text-xs font-semibold border border-rose-200";
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", function() {
          if (!confirm("この書籍を削除しますか？")) return;
          books.splice(index, 1);
          saveBooks();
          renderBooks();
        });

        item.appendChild(info);
        item.appendChild(delBtn);
        booksListEl.appendChild(item);
      });
    }

    // ====== 書籍情報取得（ダミー or API連携に拡張可） ======
    function fetchBookInfoByIsbn(isbn) {
      return Promise.resolve({
        title: "ISBN " + isbn + " の書籍",
        authors: "不明"
      });
    }

    function registerBookByIsbn(isbn) {
      isbn = isbn.replace(/[^0-9]/g, "");
      if (isbn.length !== 13) {
        alert("ISBN-13（13桁）のコードではありません。");
        return;
      }

      var exists = books.some(function(b) { return b.isbn === isbn; });
      if (exists) {
        statusMessage.textContent = "このコードはすでに登録されています。";
        var found = books.find(function(b) { return b.isbn === isbn; });
        lastCodeEl.textContent    = found.isbn;
        lastTitleEl.textContent   = found.title;
        lastAuthorsEl.textContent = found.authors;
        return;
      }

      statusMessage.textContent = "書籍情報を取得しています…";
      fetchBookInfoByIsbn(isbn).then(function(info) {
        var book = {
          isbn: isbn,
          title: info.title,
          authors: info.authors
        };
        books.push(book);
        saveBooks();
        renderBooks();

        lastCodeEl.textContent    = isbn;
        lastTitleEl.textContent   = info.title;
        lastAuthorsEl.textContent = info.authors;
        statusMessage.textContent = "書籍を登録しました。";
      }).catch(function(err) {
        console.error("fetchBookInfoByIsbn error:", err);
        statusMessage.textContent =
          "書籍情報の取得に失敗しましたが、コードのみ登録します。";
        var book = {
          isbn: isbn,
          title: "タイトル不明",
          authors: "著者不明"
        };
        books.push(book);
        saveBooks();
        renderBooks();
      });
    }

    // ====== 手入力登録 ======
    manualAddBtn.addEventListener("click", function() {
      var val = manualIsbnInput.value.trim();
      if (!val) {
        alert("ISBNコードを入力してください。");
        return;
      }
      registerBookByIsbn(val);
      manualIsbnInput.value = "";
    });

    manualIsbnInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        manualAddBtn.click();
      }
    });

    // ====== CSVエクスポート ======
    function toCsvField(value) {
      if (value == null) return "";
      var v = String(value);
      if (v.includes('"') || v.includes(",") || v.includes("\n")) {
        v = '"' + v.replace(/"/g, '""') + '"';
      }
      return v;
    }

    function exportBooksToCsv() {
      if (!books.length) {
        alert("エクスポートする書籍がありません。");
        return;
      }
      var lines = [];
      lines.push(["code", "title", "authors"].map(toCsvField).join(","));

      books.forEach(function(b) {
        var row = [
          toCsvField(b.isbn),
          toCsvField(b.title),
          toCsvField(b.authors)
        ];
        lines.push(row.join(","));
      });

      var csvContent = lines.join("\r\n");
      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url  = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "books.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    exportCsvBtn.addEventListener("click", exportBooksToCsv);

    // ====== CSVインポート ======
    function parseCsv(text) {
      var lines = text.split(/\r?\n/);
      var result = [];
      var headers = null;

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;

        var fields = [];
        var current = "";
        var inQuotes = false;
        for (var j = 0; j < line.length; j++) {
          var ch = line[j];
          if (inQuotes) {
            if (ch === '"') {
              if (j + 1 < line.length && line[j + 1] === '"') {
                current += '"';
                j++;
              } else {
                inQuotes = false;
              }
            } else {
              current += ch;
            }
          } else {
            if (ch === '"') {
              inQuotes = true;
            } else if (ch === ",") {
              fields.push(current);
              current = "";
            } else {
              current += ch;
            }
          }
        }
        fields.push(current);

        if (!headers) {
          headers = fields;
        } else {
          var obj = {};
          for (var k = 0; k < headers.length; k++) {
            var key = headers[k];
            obj[key] = fields[k] || "";
          }
          result.push(obj);
        }
      }
      return result;
    }

    function importBooksFromCsv(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result;
        var rows = parseCsv(text);
        var count = 0;

        rows.forEach(function(row) {
          var code = (row.code || "").replace(/[^0-9]/g, "");
          if (!code || code.length !== 13) return;

          var exists = books.some(function(b) { return b.isbn === code; });
          if (exists) return;

          var title   = row.title   || "タイトル不明";
          var authors = row.authors || "著者不明";

          books.push({
            isbn: code,
            title: title,
            authors: authors
          });
          count++;
        });

        if (count > 0) {
          saveBooks();
          renderBooks();
          alert(count + "件の書籍をインポートしました。");
        } else {
          alert("インポートできる書籍データがありませんでした。");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    importCsvInput.addEventListener("change", function(e) {
      var file = e.target.files[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith(".csv")) {
        alert("CSVファイルを選択してください。");
        return;
      }
      importBooksFromCsv(file);
      e.target.value = "";
    });

    // ====== 全削除 ======
    clearAllBtn.addEventListener("click", function() {
      if (!books.length) {
        alert("削除する書籍がありません。");
        return;
      }
      if (!confirm("登録されているすべての書籍を削除しますか？")) return;
      books = [];
      saveBooks();
      renderBooks();
      lastCodeEl.textContent    = "まだ読み取りは行われていません";
      lastTitleEl.textContent   = "-";
      lastAuthorsEl.textContent = "-";
      statusMessage.textContent = "すべて削除しました。";
    });

    // ====== カメラ / バーコード読み取り ======
    var isCameraRunning   = false;
    var currentStream     = null;
    var currentVideoEl    = null;
    var scanCanvas        = document.createElement("canvas");
    var scanContext       = scanCanvas.getContext("2d");
    var lastDetectedValue = null;
    var lastDetectedTime  = 0;

    var barcodeDetector = null;
    if ("BarcodeDetector" in window) {
      try {
        barcodeDetector = new BarcodeDetector({ formats: ["ean_13", "ean_8"] });
      } catch (e) {
        console.warn("BarcodeDetector 初期化失敗:", e);
        barcodeDetector = null;
      }
    }

    function onBarcodeDetected(rawCode) {
      var now = Date.now();
      if (rawCode === lastDetectedValue && now - lastDetectedTime < 3000) {
        return;
      }
      lastDetectedValue = rawCode;
      lastDetectedTime  = now;

      lastCodeEl.textContent = rawCode;

      var numeric = rawCode.replace(/[^0-9]/g, "");
      if (numeric.length === 13) {
        registerBookByIsbn(numeric);
      } else {
        statusMessage.textContent =
          "バーコードは読み取れましたが、ISBN-13ではないようです。";
      }
    }

    // ====== カメラ起動 ======
    function startCamera() {
      statusMessage.textContent = "カメラ起動処理を開始します…";

      if (isCameraRunning) {
        statusMessage.textContent = "すでにカメラは起動中です。";
        return;
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusMessage.textContent =
          "このブラウザは getUserMedia に対応していません。";
        return;
      }

      var target = document.getElementById("interactive");
      target.innerHTML = "";

      var video = document.createElement("video");
      video.setAttribute("autoplay", "true");
      video.setAttribute("playsinline", "true");
      video.setAttribute("muted", "true");
      video.className = "w-full h-full object-cover";
      currentVideoEl = video;
      target.appendChild(video);

      var constraints = {
        video: { facingMode: { ideal: "environment" } },
        audio: false
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
          currentStream = stream;
          isCameraRunning = true;
          statusMessage.textContent = "カメラを起動しました。バーコードをかざしてください。";

          if ("srcObject" in video) {
            video.srcObject = stream;
          } else {
            video.src = window.URL.createObjectURL(stream);
          }

          video.onloadedmetadata = function() {
            video.play();
            startScanLoop();
          };
        })
        .catch(function(err) {
          console.error("getUserMedia error:", err);
          statusMessage.textContent =
            "カメラの起動に失敗しました。権限設定や接続状況を確認してください。";
          target.innerHTML = "カメラ起動エラー";
        });
    }

    // ====== スキャンループ ======
    function startScanLoop() {
      if (!currentVideoEl) return;

      function tick() {
        if (!isCameraRunning || !currentVideoEl) return;

        var video = currentVideoEl;
        var vw = video.videoWidth || 0;
        var vh = video.videoHeight || 0;
        if (!vw || !vh) {
          requestAnimationFrame(tick);
          return;
        }

        var dw = vw;
        var dh = vh;
        scanCanvas.width = dw;
        scanCanvas.height = dh;
        scanContext.drawImage(video, 0, 0, dw, dh);

        if (barcodeDetector) {
          barcodeDetector.detect(scanCanvas)
            .then(function(barcodes) {
              if (!barcodes || !barcodes.length) return;
              var raw = barcodes[0].rawValue || "";
              if (!raw) return;
              onBarcodeDetected(String(raw));
            })
            ["catch"](function(err) {
              console.warn("BarcodeDetector error:", err);
            });
          requestAnimationFrame(tick);
          return;
        }

        Quagga.decodeSingle({
          src: scanCanvas.toDataURL("image/png"),
          numOfWorkers: 0,
          inputStream: {
            size: dw + "x" + dh
          },
          decoder: {
            readers: ["ean_reader", "ean_13_reader"]
          },
          locate: true
        }, function(result) {
          if (result && result.codeResult && result.codeResult.code) {
            onBarcodeDetected(result.codeResult.code);
          }
          requestAnimationFrame(tick);
        });
      }

      requestAnimationFrame(tick);
    }

    // ====== カメラ停止 ======
    function stopCamera() {
      if (!isCameraRunning) {
        statusMessage.textContent = "カメラはすでに停止しています。";
        return;
      }
      if (currentStream) {
        currentStream.getTracks().forEach(function(track) {
          track.stop();
        });
      }
      currentStream  = null;
      currentVideoEl = null;
      isCameraRunning = false;

      var target = document.getElementById("interactive");
      target.innerHTML = "カメラ停止中";

      statusMessage.textContent = "カメラを停止しました。";
    }

    startCameraBtn.addEventListener("click", startCamera);
    stopCameraBtn.addEventListener("click", stopCamera);

    // ====== 初期化 ======
    document.addEventListener("DOMContentLoaded", function() {
      loadBooks();
      renderBooks();

      if ("BarcodeDetector" in window) {
        try {
          barcodeDetector = new BarcodeDetector({ formats: ["ean_13", "ean_8"] });
          statusMessage.textContent =
            "準備完了：カメラ起動ボタンを押してください。（BarcodeDetector 対応）";
        } catch (e) {
          barcodeDetector = null;
          statusMessage.textContent =
            "準備完了：カメラ起動ボタンを押してください。（フォールバック: Quagga）";
        }
      } else {
        statusMessage.textContent =
          "準備完了：カメラ起動ボタンを押してください。（BarcodeDetector なし／Quagga使用）";
      }
    });
  </script>
</body>
</html>
