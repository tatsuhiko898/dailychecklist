<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>蔵書管理アプリ（バーコード／CSV対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind（ローカル + SRI） -->
  <script
    src="vendor/tailwind.js"
    integrity="sha384-8+w8wtm5WETGRGZ1EZ7VGgFCRHAsneVQXyAu1WdiFk3YuMZRBC6bSzFPxyx0YRYm"
    crossorigin="anonymous"
  ></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-6 md:py-10">
    <header class="mb-6 md:mb-8">
      <h1 class="text-xl md:text-2xl font-bold text-slate-800">
        蔵書管理アプリ
      </h1>
      <p class="text-xs md:text-sm text-slate-600 mt-2">
        カメラでバーコード（ISBN）を読み取って、本の情報を登録できます。<br />
        また、CSVファイルでのインポート／エクスポートにも対応しています。
      </p>
    </header>

    <!-- カメラ & 最新情報 -->
    <section
      class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-6 md:mb-10"
    >
      <!-- カメラ -->
      <div
        class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 md:p-6 flex flex-col"
      >
        <div class="flex items-center justify-between mb-3 md:mb-4">
          <h2 class="text-base md:text-lg font-semibold text-slate-800">
            バーコード読み取り（カメラ）
          </h2>
          <span
            id="camera-status"
            class="inline-flex items-center gap-1 text-xs md:text-sm px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 border border-slate-200"
          >
            <span class="w-2 h-2 rounded-full bg-slate-300"></span>
            カメラ停止中
          </span>
        </div>

        <div class="space-y-3 md:space-y-4">
          <div class="flex flex-wrap gap-2">
            <button
              id="start-camera"
              class="px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm font-semibold rounded-full bg-emerald-500 text-white shadow-sm hover:bg-emerald-600 transition"
            >
              カメラ起動
            </button>
            <button
              id="stop-camera"
              class="px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm font-semibold rounded-full bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 transition"
            >
              カメラ停止
            </button>
          </div>
          <p id="camera-message" class="text-xs md:text-sm text-slate-600">
            「カメラ起動」を押すとバーコード読み取りを開始します。
          </p>

          <div
            class="mt-1 relative rounded-xl overflow-hidden bg-slate-900 border border-slate-700"
          >
            <div
              id="camera-view"
              class="relative w-full aspect-[4/3] flex items-center justify-center text-slate-400 text-xs md:text-sm select-none"
            >
              カメラ停止中
            </div>
          </div>

          <p class="text-[11px] md:text-xs text-slate-500 leading-relaxed">
            ※ カメラがうまく動作しない場合：<br />
            ・PCの場合は「https://」で始まるページであること、または「localhost」で開いてください。<br />
            ・スマートフォンの場合、ブラウザのカメラ使用許可を確認してください。<br />
            ・読み取りが難しい場合は、ISBNコードを手入力して登録することも可能です。
          </p>
        </div>
      </div>

      <!-- 最新読み取り結果 -->
      <div
        class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 md:p-6"
      >
        <h2 class="text-base md:text-lg font-semibold text-slate-800 mb-3">
          最新の読み取り結果
        </h2>
        <div class="space-y-3">
          <div class="text-xs md:text-sm text-slate-700">
            <div class="text-slate-500 text-[11px] md:text-xs mb-1">
              最後に読み取ったコード
            </div>
            <div
              id="last-isbn"
              class="font-mono text-sm md:text-base bg-slate-50 border border-slate-200 rounded-md px-2 py-1"
            >
              まだ読み取りは行われていません
            </div>
          </div>
          <div class="text-xs md:text-sm text-slate-700">
            <div class="text-slate-500 text-[11px] md:text-xs mb-1">
              書籍タイトル
            </div>
            <div
              id="last-title"
              class="bg-slate-50 border border-slate-200 rounded-md px-2 py-1"
            >
              -
            </div>
          </div>
          <div class="text-xs md:text-sm text-slate-700">
            <div class="text-slate-500 text-[11px] md:text-xs mb-1">
              著者
            </div>
            <div
              id="last-authors"
              class="bg-slate-50 border border-slate-200 rounded-md px-2 py-1"
            >
              -
            </div>
          </div>
        </div>
        <p
          id="status-message"
          class="mt-4 text-xs md:text-sm text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-md px-2 py-1 hidden"
        ></p>
      </div>
    </section>

    <!-- 手入力 & CSV -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-6">
      <!-- 手入力 -->
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
        <h2 class="text-base md:text-lg font-semibold text-slate-800 mb-3">
          ISBN コードの手入力
        </h2>
        <p class="text-xs md:text-sm text-slate-600 mb-3">
          カメラが使えない場合やバーコードがうまく読み取れない場合は、ISBNコードを手入力してください。
        </p>
        <div class="flex flex-col gap-3">
          <input
            id="isbn-input"
            type="text"
            inputmode="numeric"
            placeholder="例）9784049122204"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 font-mono"
          />
          <button
            id="add-isbn"
            class="w-full inline-flex justify-center items-center px-4 py-2 text-xs md:text-sm font-semibold rounded-lg bg-emerald-500 text-white shadow-sm hover:bg-emerald-600 transition"
          >
            コードを登録
          </button>
          <p class="text-[11px] md:text-xs text-slate-500">
            ※ ISBN-13（13桁の数字）で入力してください。
          </p>
        </div>
      </div>

      <!-- CSV 入出力 -->
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
        <h2 class="text-base md:text-lg font-semibold text-slate-800 mb-3">
          CSV インポート / エクスポート
        </h2>
        <p class="text-xs md:text-sm text-slate-600 mb-3">
          登録した書籍情報を CSV ファイルとして保存したり、CSV ファイルから読み込むことができます。
        </p>

        <div class="space-y-4">
          <!-- Export -->
          <div
            class="border border-slate-200 rounded-xl p-3 flex flex-col gap-2"
          >
            <div class="flex items-center justify-between">
              <span class="text-xs md:text-sm font-semibold text-slate-700">
                エクスポート（書き出し）
              </span>
              <button
                id="export-csv"
                class="inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-full bg-sky-500 text-white hover:bg-sky-600 transition"
              >
                CSVをダウンロード
              </button>
            </div>
            <p class="text-[11px] md:text-xs text-slate-500 leading-relaxed">
              現在登録されている書籍情報を
              <code class="font-mono bg-slate-50 px-1 py-0.5 rounded"
                >code,title,authors</code
              >
              形式の CSV ファイルとしてダウンロードします。
            </p>
          </div>

          <!-- Import -->
          <div
            class="border border-slate-200 rounded-xl p-3 flex flex-col gap-2"
          >
            <div class="flex items-center justify-between">
              <span class="text-xs md:text-sm font-semibold text-slate-700">
                インポート（読み込み）
              </span>
              <label
                class="inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-full bg-violet-500 text-white hover:bg-violet-600 transition cursor-pointer"
              >
                CSVファイルを選択
                <input
                  id="import-csv"
                  type="file"
                  accept=".csv,text/csv"
                  class="hidden"
                />
              </label>
            </div>
            <p class="text-[11px] md:text-xs text-slate-500 leading-relaxed">
              <span class="font-semibold">フォーマット：</span>
              1行目にヘッダ
              <code class="font-mono bg-slate-50 px-1 py-0.5 rounded"
                >code,title,authors</code
              >
              を記述し、2行目以降にデータ行を記述してください。<br />
              code は ISBN（13桁の数字）、title は書籍名、authors
              は著者名（カンマ区切り可）です。
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- 登録済み一覧 -->
    <section class="mb-8">
      <div class="flex items-center justify-between mb-3 md:mb-4">
        <h2 class="text-base md:text-lg font-semibold text-slate-800">
          登録済みの書籍一覧
        </h2>
        <button
          id="clear-all"
          class="text-xs md:text-sm px-3 py-1.5 rounded-full border border-rose-200 text-rose-600 bg-rose-50 hover:bg-rose-100 transition"
        >
          すべて削除
        </button>
      </div>
      <p
        id="books-empty-message"
        class="text-xs md:text-sm text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-xl px-3 py-2"
      >
        まだ書籍は登録されていません。バーコードの読み取りや ISBN
        の手入力、CSVインポートで書籍を追加してください。
      </p>
      <div
        id="books-list"
        class="mt-3 md:mt-4 space-y-3 md:space-y-4 text-xs md:text-sm"
      ></div>
    </section>

    <footer class="pt-4 border-t border-slate-200 text-[11px] md:text-xs text-slate-500">
      <p class="mb-1">
        ・本アプリはブラウザのローカルストレージにのみデータを保存します。サーバには送信されません。
      </p>
      <p>
        ・ISBNから書籍情報を取得する際、Google Books API にアクセスします。その際、ISBNコードがGoogleに送信されます。
      </p>
    </footer>
  </div>

  <!-- QuaggaJS（ローカル + SRI） -->
  <script
    src="vendor/quagga.min.js"
    integrity="sha384-sl2LNalPRD3qrS3TKmINXWwRcQKf9cUlNZGd8pqjlpzwbzgMsFgE+133u4kM32IR"
    crossorigin="anonymous"
  ></script>

  <script>
    // ====== DOM取得 ======
    var cameraStatusEl = document.getElementById("camera-status");
    var cameraMessageEl = document.getElementById("camera-message");
    var cameraViewEl = document.getElementById("camera-view");
    var startCameraBtn = document.getElementById("start-camera");
    var stopCameraBtn = document.getElementById("stop-camera");

    var lastIsbnEl = document.getElementById("last-isbn");
    var lastTitleEl = document.getElementById("last-title");
    var lastAuthorsEl = document.getElementById("last-authors");
    var statusMessage = document.getElementById("status-message");

    var isbnInput = document.getElementById("isbn-input");
    var addIsbnBtn = document.getElementById("add-isbn");

    var exportCsvBtn = document.getElementById("export-csv");
    var importCsvInput = document.getElementById("import-csv");

    var booksListEl = document.getElementById("books-list");
    var booksEmptyMessageEl = document.getElementById("books-empty-message");
    var clearAllBtn = document.getElementById("clear-all");

    // ====== 状態管理 ======
    var books = [];
    var lastScannedTime = 0;
    var lastScannedCode = null;

    var STORAGE_KEY = "isbnBookList";

    // ローカルストレージから読み込み
    function loadBooks() {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        books = [];
        return;
      }
      try {
        var parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          books = parsed;
        } else {
          books = [];
        }
      } catch (e) {
        console.error("Failed to parse books from localStorage", e);
        books = [];
      }
    }

    function saveBooks() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    }

    // ====== 表示更新 ======
    function renderBooks() {
      booksListEl.innerHTML = "";
      if (!books.length) {
        booksEmptyMessageEl.classList.remove("hidden");
        return;
      }
      booksEmptyMessageEl.classList.add("hidden");

      for (var i = 0; i < books.length; i++) {
        (function (index) {
          var b = books[index];
          var item = document.createElement("div");
          item.className =
            "bg-white border border-slate-200 rounded-xl p-4 flex justify-between items-start gap-4";

          var info = document.createElement("div");

          // タイトル
          var titleEl = document.createElement("div");
          titleEl.className = "font-semibold text-sm md:text-base";
          titleEl.textContent = b.title;

          // 著者
          var authorsEl = document.createElement("div");
          authorsEl.className = "text-xs md:text-sm text-slate-600";
          authorsEl.textContent = "著者：" + b.authors;

          // コード
          var codeEl = document.createElement("div");
          codeEl.className = "text-xs text-slate-500 font-mono mt-1";
          codeEl.textContent = "コード：" + b.isbn;

          info.appendChild(titleEl);
          info.appendChild(authorsEl);
          info.appendChild(codeEl);

          var delBtn = document.createElement("button");
          delBtn.className =
            "px-3 py-1 rounded-md bg-rose-50 text-rose-600 text-xs font-semibold border border-rose-200";
          delBtn.textContent = "削除";
          delBtn.onclick = function () {
            if (confirm("この書籍を削除しますか？")) {
              books.splice(index, 1);
              saveBooks();
              renderBooks();
            }
          };

          item.appendChild(info);
          item.appendChild(delBtn);
          booksListEl.appendChild(item);
        })(i);
      }
    }

    // ====== 書籍情報取得 ======
    function fetchBookByIsbn(isbn) {
      return fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:" + isbn)
        .then(function (res) {
          if (!res.ok) {
            throw new Error("Network response was not ok");
          }
          return res.json();
        })
        .then(function (data) {
          if (!data.items || !data.items.length) {
            return {
              title: "(タイトル不明)",
              authors: "(著者不明)",
            };
          }
          var vol = data.items[0].volumeInfo || {};
          return {
            title: vol.title || "(タイトル不明)",
            authors: (vol.authors || ["(著者不明)"]).join(", "),
          };
        })
        .catch(function () {
          return {
            title: "(タイトル不明)",
            authors: "(著者不明)",
          };
        });
    }

    function registerBook(isbn) {
      for (var i = 0; i < books.length; i++) {
        if (books[i].isbn === isbn) {
          statusMessage.textContent = "このコードはすでに登録されています。";
          statusMessage.classList.remove("hidden");
          lastIsbnEl.textContent = books[i].isbn;
          lastTitleEl.textContent = books[i].title;
          lastAuthorsEl.textContent = books[i].authors;
          return;
        }
      }

      statusMessage.textContent = "書籍情報を取得しています...";
      statusMessage.classList.remove("hidden");

      fetchBookByIsbn(isbn).then(function (info) {
        var book = {
          isbn: isbn,
          title: info.title,
          authors: info.authors,
        };
        books.push(book);
        saveBooks();
        renderBooks();

        lastIsbnEl.textContent = isbn;
        lastTitleEl.textContent = info.title;
        lastAuthorsEl.textContent = info.authors;
        statusMessage.textContent = "書籍を登録しました。";
      });
    }

    // ====== カメラ／バーコード ======
    var isCameraActive = false;

    function startCamera() {
      if (isCameraActive) return;

      var constraints = {
        width: 640,
        height: 480,
        facingMode: "environment",
      };

      cameraMessageEl.textContent =
        "カメラ起動しました。バーコードを中央にかざしてください。";
      cameraViewEl.innerHTML = "";

      var liveRegion = document.createElement("div");
      liveRegion.setAttribute("aria-live", "off");

      var textOverlay = document.createElement("div");
      textOverlay.textContent = "カメラを起動中...";
      textOverlay.className =
        "absolute inset-0 flex items-center justify中心 text-slate-300 text-xs md:text-sm";
      cameraViewEl.appendChild(textOverlay);

      Quagga.init(
        {
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: cameraViewEl,
            constraints: constraints,
          },
          decoder: {
            readers: ["ean_reader"],
          },
          locate: true,
        },
        function (err) {
          if (err) {
            console.error(err);
            cameraMessageEl.textContent =
              "カメラの起動に失敗しました。ブラウザの設定や接続状況を確認してください。";
            cameraViewEl.textContent = "カメラ起動エラー";
            return;
          }
          Quagga.start();
          isCameraActive = true;
          cameraStatusEl.innerHTML =
            '<span class="inline-flex items-center gap-1 text-xs md:text-sm px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">' +
            '<span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>スキャン中</span>';
          cameraViewEl.removeChild(textOverlay);
        }
      );

      Quagga.onDetected(function (result) {
        if (!result || !result.codeResult || !result.codeResult.code) {
          return;
        }
        var code = result.codeResult.code;
        var now = Date.now();

        if (code === lastScannedCode && now - lastScannedTime < 5000) {
          return;
        }
        lastScannedCode = code;
        lastScannedTime = now;

        var isbn = code.replace(/[^0-9]/g, "");
        if (isbn.length !== 13) {
          statusMessage.textContent =
            "バーコードは読み取りましたが、ISBN-13ではないようです。";
          statusMessage.classList.remove("hidden");
          lastIsbnEl.textContent = code;
          lastTitleEl.textContent = "-";
          lastAuthorsEl.textContent = "-";
          return;
        }

        registerBook(isbn);
      });
    }

    function stopCamera() {
      if (!isCameraActive) return;
      Quagga.stop();
      Quagga.offDetected();
      isCameraActive = false;
      cameraMessageEl.textContent = "カメラを停止しました。";
      cameraViewEl.innerHTML = "";
      cameraViewEl.textContent = "カメラ停止中";
      cameraStatusEl.innerHTML =
        '<span class="inline-flex items-center gap-1 text-xs md:text-sm px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 border border-slate-200">' +
        '<span class="w-2 h-2 rounded-full bg-slate-300"></span>カメラ停止中</span>';
    }

    startCameraBtn.addEventListener("click", startCamera);
    stopCameraBtn.addEventListener("click", stopCamera);

    // ====== 手入力処理 ======
    addIsbnBtn.addEventListener("click", function () {
      var val = isbnInput.value.replace(/[^0-9]/g, "");
      if (!val) {
        alert("ISBNコードを入力してください。");
        return;
      }
      if (val.length !== 13) {
        alert("ISBN-13（13桁）で入力してください。");
        return;
      }
      registerBook(val);
      isbnInput.value = "";
    });

    isbnInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        addIsbnBtn.click();
      }
    });

    // ====== CSV エクスポート ======
    // ★CSVインジェクション対策：= + - @ で始まる値はプレフィックスを付けて数式扱いさせない
    function sanitizeForSpreadsheet(value) {
      if (value == null) return "";
      var s = String(value);
      if (/^[=+\-@]/.test(s)) {
        s = "'" + s;
      }
      return s;
    }

    function toCsvField(value) {
      if (value == null) return "";
      var v = String(value);
      if (v.includes('"') || v.includes(",") || v.includes("\n")) {
        v = '"' + v.replace(/"/g, '""') + '"';
      }
      return v;
    }

    function exportBooksToCsv() {
      if (!books.length) {
        alert("エクスポートする書籍がありません。");
        return;
      }
      var lines = [];
      // ヘッダ行
      lines.push(["code", "title", "authors"].map(toCsvField).join(","));

      for (var i = 0; i < books.length; i++) {
        var b = books[i];
        // ★ 各値をスプレッドシート向けに無害化してから CSV エスケープ
        var row = [
          toCsvField(sanitizeForSpreadsheet(b.isbn)),
          toCsvField(sanitizeForSpreadsheet(b.title)),
          toCsvField(sanitizeForSpreadsheet(b.authors))
        ];
        lines.push(row.join(","));
      }

      var csvContent = lines.join("\r\n");
      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "books.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    exportCsvBtn.addEventListener("click", exportBooksToCsv);

    // ====== CSV インポート ======
    function parseCsv(text) {
      var lines = text.split(/\r?\n/);
      var result = [];
      var headers = null;

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;

        var fields = [];
        var current = "";
        var inQuotes = false;
        for (var j = 0; j < line.length; j++) {
          var ch = line[j];
          if (inQuotes) {
            if (ch === '"') {
              if (j + 1 < line.length && line[j + 1] === '"') {
                current += '"';
                j++;
              } else {
                inQuotes = false;
              }
            } else {
              current += ch;
            }
          } else {
            if (ch === '"') {
              inQuotes = true;
            } else if (ch === ",") {
              fields.push(current);
              current = "";
            } else {
              current += ch;
            }
          }
        }
        fields.push(current);

        if (!headers) {
          headers = fields;
        } else {
          var obj = {};
          for (var k = 0; k < headers.length; k++) {
            var key = headers[k];
            obj[key] = fields[k] || "";
          }
          result.push(obj);
        }
      }
      return result;
    }

    function importBooksFromCsv(file) {
      var reader = new FileReader();
      reader.onload = function (e) {
        var text = e.target.result;
        var rows = parseCsv(text);
        var count = 0;

        rows.forEach(function (row) {
          var code = (row.code || "").replace(/[^0-9]/g, "");
          if (code.length !== 13) return;
          var exists = books.some(function (b) {
            return b.isbn === code;
          });
          if (exists) return;

          var title = row.title || "(タイトル不明)";
          var authors = row.authors || "(著者不明)";

          books.push({
            isbn: code,
            title: title,
            authors: authors,
          });
          count++;
        });

        if (count > 0) {
          saveBooks();
          renderBooks();
          alert(count + "件の書籍をインポートしました。");
        } else {
          alert("インポート可能な書籍データが見つかりませんでした。");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    importCsvInput.addEventListener("change", function (e) {
      var file = e.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith(".csv")) {
        alert("CSVファイルを選択してください。");
        return;
      }
      importBooksFromCsv(file);
      e.target.value = "";
    });

    // ====== 一括削除 ======
    clearAllBtn.addEventListener("click", function () {
      if (!books.length) {
        alert("削除する書籍がありません。");
        return;
      }
      if (confirm("登録されているすべての書籍を削除しますか？")) {
        books = [];
        saveBooks();
        renderBooks();
        lastIsbnEl.textContent = "まだ読み取りは行われていません";
        lastTitleEl.textContent = "-";
        lastAuthorsEl.textContent = "-";
        statusMessage.textContent = "";
        statusMessage.classList.add("hidden");
      }
    });

    // ====== 初期化 ======
    loadBooks();
    renderBooks();

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      cameraMessageEl.textContent =
        "このブラウザはカメラアクセスに対応していないか、許可されていません。";
      cameraViewEl.textContent = "カメラ非対応（Quagga使用）";
    }
  </script>
</body>
</html>
