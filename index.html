<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>服薬記録カレンダー</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-sky-50 via-indigo-50 to-pink-50 p-4">
  <div class="w-full max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-7 space-y-7">

    <!-- ヘッダー -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">服薬記録カレンダー</h1>
        <p class="text-sm text-slate-600 mt-1">
          朝・昼・晩の服薬を記録して、あとから確認できます。
        </p>
      </div>

      <div class="flex gap-2">
        <button id="prev-month-btn"
                class="text-sm px-3 py-1.5 rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200 transition">
          ◀ 前の月
        </button>
        <button id="today-btn"
                class="text-sm px-3 py-1.5 rounded-full bg-emerald-400 text-white shadow hover:bg-emerald-500 transition">
          今日へ
        </button>
        <button id="next-month-btn"
                class="text-sm px-3 py-1.5 rounded-full bg-sky-100 text-sky-700 hover:bg-sky-200 transition">
          次の月 ▶
        </button>
      </div>
    </header>

    <!-- カレンダー -->
    <section class="space-y-3">
      <div id="month-label" class="text-xl font-semibold text-slate-700"></div>

      <div class="border border-slate-200 rounded-2xl p-4 bg-white shadow-sm">
        <div class="grid grid-cols-7 text-center text-sm font-semibold text-slate-600 mb-2">
          <div>月</div><div>火</div><div>水</div><div>木</div><div>金</div>
          <div class="text-sky-600">土</div>
          <div class="text-rose-500">日</div>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-2">
        </div>
      </div>
    </section>

    <!-- 詳細 -->
    <section class="border-t border-slate-200 pt-4 space-y-4">
      <div class="flex justify-between items-center">
        <div id="selected-date-label" class="text-lg font-semibold text-slate-800"></div>
        <span class="text-xs text-slate-500">チェックすると現在時刻が保存されます</span>
      </div>

      <div class="space-y-3">

        <!-- 朝 -->
        <div class="flex justify-between items-center bg-amber-50 border border-amber-200 rounded-2xl px-4 py-3">
          <div class="flex items-center gap-3">
            <input id="morning-checkbox" type="checkbox"
                   class="h-5 w-5 text-amber-500 rounded focus:ring-amber-400">
            <span class="text-base font-semibold text-amber-800">朝</span>
          </div>
          <div id="morning-time-container" class="hidden text-sm text-amber-700">
            服薬時刻：<span id="morning-time" class="font-mono"></span>
          </div>
        </div>

        <!-- 昼 -->
        <div class="flex justify-between items-center bg-emerald-50 border border-emerald-200 rounded-2xl px-4 py-3">
          <div class="flex items-center gap-3">
            <input id="noon-checkbox" type="checkbox"
                   class="h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400">
            <span class="text-base font-semibold text-emerald-800">昼</span>
          </div>
          <div id="noon-time-container" class="hidden text-sm text-emerald-700">
            服薬時刻：<span id="noon-time" class="font-mono"></span>
          </div>
        </div>

        <!-- 晩 -->
        <div class="flex justify-between items-center bg-indigo-50 border border-indigo-200 rounded-2xl px-4 py-3">
          <div class="flex items-center gap-3">
            <input id="evening-checkbox" type="checkbox"
                   class="h-5 w-5 text-indigo-500 rounded focus:ring-indigo-400">
            <span class="text-base font-semibold text-indigo-800">晩</span>
          </div>
          <div id="evening-time-container" class="hidden text-sm text-indigo-700">
            服薬時刻：<span id="evening-time" class="font-mono"></span>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'medicationTracker_v2_color';
      const weekdayNames = ['日','月','火','水','木','金','土'];

      let data = {};
      let selectedDate;
      let currentYear, currentMonth;

      const calendarGrid = document.getElementById('calendar-grid');
      const monthLabel = document.getElementById('month-label');
      const selectedDateLabel = document.getElementById('selected-date-label');

      const morningCheckbox = document.getElementById('morning-checkbox');
      const noonCheckbox = document.getElementById('noon-checkbox');
      const eveningCheckbox = document.getElementById('evening-checkbox');

      const morningTimeContainer = document.getElementById('morning-time-container');
      const noonTimeContainer = document.getElementById('noon-time-container');
      const eveningTimeContainer = document.getElementById('evening-time-container');

      const morningTime = document.getElementById('morning-time');
      const noonTime = document.getElementById('noon-time');
      const eveningTime = document.getElementById('evening-time');

      function pad(n){return n.toString().padStart(2,'0');}
      function key(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}

      function load(){
        try{ data=JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ data={}; }
      }
      function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); }

      function getDay(k){
        if(!data[k]) data[k]={morning:{c:false,t:null},noon:{c:false,t:null},evening:{c:false,t:null}};
        return data[k];
      }

      function render(){
        monthLabel.textContent=`${currentYear}年${currentMonth+1}月`;
        calendarGrid.innerHTML='';

        const first=new Date(currentYear,currentMonth,1);
        const last=new Date(currentYear,currentMonth+1,0);
        const offset=(first.getDay()+6)%7;

        for(let i=0;i<offset;i++){
          const div=document.createElement('div');
          calendarGrid.appendChild(div);
        }

        for(let d=1;d<=last.getDate();d++){
          const date=new Date(currentYear,currentMonth,d);
          const k=key(date);
          const dayData=getDay(k);

          const cell=document.createElement('div');
          cell.dataset.date=k;
          cell.className="rounded-2xl border bg-white min-h-[70px] p-2 cursor-pointer shadow hover:shadow-md transition";

          const top=document.createElement('div');
          top.className="text-sm font-bold";
          top.textContent=d;
          cell.appendChild(top);

          const row=document.createElement('div');
          row.className="flex justify-between mt-2";

          function pill(label,flag,color){
            const s=document.createElement('span');
            s.textContent=label;
            s.className= flag
              ? `text-${color}-700 font-bold`
              : 'text-slate-300';
            return s;
          }

          row.appendChild(pill('朝',dayData.morning.c,'amber'));
          row.appendChild(pill('昼',dayData.noon.c,'emerald'));
          row.appendChild(pill('晩',dayData.evening.c,'indigo'));
          cell.appendChild(row);

          cell.onclick=()=>setSelected(date);
          calendarGrid.appendChild(cell);
        }

        highlight();
      }

      function highlight(){
        const k=key(selectedDate);
        document.querySelectorAll('#calendar-grid div[data-date]')
          .forEach(c=>{
            c.classList.remove('ring-2','ring-emerald-400');
            if(c.dataset.date===k) c.classList.add('ring-2','ring-emerald-400');
          });
      }

      function setSelected(date){
        selectedDate=new Date(date);
        const k=key(selectedDate);
        const dd=getDay(k);
        selectedDateLabel.textContent=
          `${selectedDate.getFullYear()}年${selectedDate.getMonth()+1}月${selectedDate.getDate()}日（${weekdayNames[selectedDate.getDay()]}）`;

        function bind(cb,box,time,cont){
          cb.checked=box.c;
          if(box.c){ cont.classList.remove('hidden'); time.textContent=box.t; }
          else{ cont.classList.add('hidden'); time.textContent='';}
        }

        bind(morningCheckbox,dd.morning,morningTime,morningTimeContainer);
        bind(noonCheckbox,dd.noon,noonTime,noonTimeContainer);
        bind(eveningCheckbox,dd.evening,eveningTime,eveningTimeContainer);

        highlight();
      }

      function toggle(kind,cb,time,cont){
        const k=key(selectedDate);
        const dd=getDay(k);
        if(cb.checked){
          const now=new Date();
          const t=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
          dd[kind].c=true; dd[kind].t=t;
          cont.classList.remove('hidden'); time.textContent=t;
        }else{
          dd[kind].c=false; dd[kind].t=null;
          cont.classList.add('hidden'); time.textContent='';
        }
        save(); render();
      }

      function init(){
        load();
        const today=new Date();
        currentYear=today.getFullYear();
        currentMonth=today.getMonth();
        selectedDate=today;

        render(); setSelected(today);

        document.getElementById('prev-month-btn').onclick=()=>{
          currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;}
          selectedDate=new Date(currentYear,currentMonth,1);
          render(); setSelected(selectedDate);
        };
        document.getElementById('next-month-btn').onclick=()=>{
          currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;}
          selectedDate=new Date(currentYear,currentMonth,1);
          render(); setSelected(selectedDate);
        };
        document.getElementById('today-btn').onclick=()=>{
          const n=new Date(); currentYear=n.getFullYear(); currentMonth=n.getMonth(); setSelected(n); render();
        };

        morningCheckbox.onchange=()=>toggle('morning',morningCheckbox,morningTime,morningTimeContainer);
        noonCheckbox.onchange=()=>toggle('noon',noonCheckbox,noonTime,noonTimeContainer);
        eveningCheckbox.onchange=()=>toggle('evening',eveningCheckbox,eveningTime,eveningTimeContainer);
      }
      init();
    })();
  </script>
</body>
</html>
