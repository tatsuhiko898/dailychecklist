<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>服薬記録カレンダー</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 space-y-6">
    <!-- ヘッダー -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold text-slate-800">服薬記録カレンダー</h1>
        <p class="text-xs text-slate-500 mt-1">
          毎日の朝・昼・晩の服薬状況をカレンダーで確認・記録できます。
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button id="prev-month-btn"
                class="text-xs px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 transition">
          前の月
        </button>
        <button id="today-btn"
                class="text-xs px-3 py-1.5 rounded-full bg-sky-500 text-white hover:bg-sky-600 shadow-sm transition">
          今日
        </button>
        <button id="next-month-btn"
                class="text-xs px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 transition">
          次の月
        </button>
      </div>
    </header>

    <!-- カレンダー上部 -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <div id="month-label" class="text-lg font-semibold text-slate-800"></div>
      </div>

      <div class="border border-slate-200 rounded-2xl p-3 bg-slate-50">
        <!-- 曜日 -->
        <div class="grid grid-cols-7 text-center text-[11px] font-semibold text-slate-500 mb-1">
          <div>月</div>
          <div>火</div>
          <div>水</div>
          <div>木</div>
          <div>金</div>
          <div class="text-sky-600">土</div>
          <div class="text-rose-500">日</div>
        </div>

        <!-- カレンダー本体 -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1.5 text-[11px]">
          <!-- JavaScript で生成 -->
        </div>
      </div>
    </section>

    <!-- 下部 詳細エリア -->
    <section class="border-t border-slate-200 pt-4 space-y-3">
      <div class="flex items-center justify-between">
        <div id="selected-date-label" class="text-base font-semibold text-slate-800"></div>
        <span class="text-[11px] text-slate-500">
          チェックすると現在時刻が記録されます
        </span>
      </div>

      <div class="space-y-2">
        <!-- 朝 -->
        <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="morning-checkbox"
                   class="h-4 w-4 rounded border-slate-300 text-sky-500 focus:ring-sky-400">
            <span class="text-sm font-medium text-slate-800">朝</span>
          </div>
          <div id="morning-time-container" class="text-xs text-slate-600 hidden">
            服薬時刻：<span id="morning-time" class="font-mono"></span>
          </div>
        </div>

        <!-- 昼 -->
        <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="noon-checkbox"
                   class="h-4 w-4 rounded border-slate-300 text-sky-500 focus:ring-sky-400">
            <span class="text-sm font-medium text-slate-800">昼</span>
          </div>
          <div id="noon-time-container" class="text-xs text-slate-600 hidden">
            服薬時刻：<span id="noon-time" class="font-mono"></span>
          </div>
        </div>

        <!-- 晩 -->
        <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="evening-checkbox"
                   class="h-4 w-4 rounded border-slate-300 text-sky-500 focus:ring-sky-400">
            <span class="text-sm font-medium text-slate-800">晩</span>
          </div>
          <div id="evening-time-container" class="text-xs text-slate-600 hidden">
            服薬時刻：<span id="evening-time" class="font-mono"></span>
          </div>
        </div>
      </div>

      <p class="text-[11px] text-slate-500 leading-relaxed">
        ・チェックした時刻が自動的に記録されます。<br>
        ・チェックを外すと、その時刻の記録と表示は消去されます。<br>
        ・データはブラウザのローカルストレージに保存されます（このブラウザのみ有効です）。
      </p>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'medicationTrackerData_v1_tailwind';

      const periods = {
        morning: '朝',
        noon: '昼',
        evening: '晩'
      };

      const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];

      let data = {};
      let currentYear, currentMonth;
      let selectedDate;

      const monthLabel = document.getElementById('month-label');
      const calendarGrid = document.getElementById('calendar-grid');
      const selectedDateLabel = document.getElementById('selected-date-label');

      const morningCheckbox = document.getElementById('morning-checkbox');
      const noonCheckbox = document.getElementById('noon-checkbox');
      const eveningCheckbox = document.getElementById('evening-checkbox');

      const morningTimeContainer = document.getElementById('morning-time-container');
      const noonTimeContainer = document.getElementById('noon-time-container');
      const eveningTimeContainer = document.getElementById('evening-time-container');

      const morningTimeSpan = document.getElementById('morning-time');
      const noonTimeSpan = document.getElementById('noon-time');
      const eveningTimeSpan = document.getElementById('evening-time');

      function pad(num) {
        return num.toString().padStart(2, '0');
      }

      function getDateKey(dateObj) {
        const y = dateObj.getFullYear();
        const m = pad(dateObj.getMonth() + 1);
        const d = pad(dateObj.getDate());
        return `${y}-${m}-${d}`;
      }

      function loadData() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            data = JSON.parse(stored);
          } else {
            data = {};
          }
        } catch (e) {
          console.error('ローカルストレージからの読み込みに失敗しました:', e);
          data = {};
        }
      }

      function saveData() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error('ローカルストレージへの保存に失敗しました:', e);
        }
      }

      function getDayData(dateKey) {
        if (!data[dateKey]) {
          data[dateKey] = {
            morning: { checked: false, time: null },
            noon: { checked: false, time: null },
            evening: { checked: false, time: null }
          };
        }
        return data[dateKey];
      }

      function formatJapaneseDate(dateObj) {
        const y = dateObj.getFullYear();
        const m = dateObj.getMonth() + 1;
        const d = dateObj.getDate();
        const weekday = weekdayNames[dateObj.getDay()];
        return `${y}年${m}月${d}日（${weekday}）`;
      }

      function renderCalendar(year, month) {
        monthLabel.textContent = `${year}年${month + 1}月`;

        calendarGrid.innerHTML = '';

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();

        // 月曜始まりのオフセット
        const jsDayOfWeek = firstDay.getDay(); // 0=日〜6=土
        const offset = (jsDayOfWeek + 6) % 7;  // 0=月〜6=日

        // 空セル
        for (let i = 0; i < offset; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'rounded-2xl min-h-[68px]';
          calendarGrid.appendChild(emptyCell);
        }

        // 日付セル
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          const dateKey = getDateKey(dateObj);

          const dayCell = document.createElement('div');
          dayCell.dataset.date = dateKey;
          dayCell.className = [
            'day-cell',
            'flex flex-col justify-between',
            'rounded-2xl',
            'border',
            'border-slate-200',
            'bg-white',
            'min-h-[68px]',
            'px-2 py-1.5',
            'cursor-pointer',
            'transition',
            'hover:border-sky-400 hover:bg-sky-50'
          ].join(' ');

          const dateNumberDiv = document.createElement('div');
          dateNumberDiv.className = 'flex items-center justify-between text-[11px] mb-1';

          const dateSpan = document.createElement('span');
          dateSpan.textContent = day;
          dateSpan.className = 'font-medium text-slate-800';

          // 週末の色
          const dow = dateObj.getDay();
          if (dow === 0) {
            dateSpan.classList.add('text-rose-500');
          } else if (dow === 6) {
            dateSpan.classList.add('text-sky-600');
          }

          dateNumberDiv.appendChild(dateSpan);
          dayCell.appendChild(dateNumberDiv);

          const statusRowDiv = document.createElement('div');
          statusRowDiv.className = 'flex justify-between gap-1';

          Object.keys(periods).forEach(periodKey => {
            const span = document.createElement('span');
            span.dataset.period = periodKey;
            span.textContent = periods[periodKey];
            span.className = 'med-label text-[11px] text-slate-300';
            statusRowDiv.appendChild(span);
          });

          dayCell.appendChild(statusRowDiv);

          dayCell.addEventListener('click', () => {
            setSelectedDate(dateObj);
          });

          calendarGrid.appendChild(dayCell);

          applyStatusToDayCell(dateKey);
        }

        highlightSelectedDate();
      }

      function applyStatusToDayCell(dateKey) {
        const dayData = data[dateKey];
        const dayCell = calendarGrid.querySelector(`.day-cell[data-date="${dateKey}"]`);
        if (!dayCell) return;

        const labels = dayCell.querySelectorAll('.med-label');
        labels.forEach(label => {
          const periodKey = label.dataset.period;
          const checked = dayData && dayData[periodKey] && dayData[periodKey].checked;

          label.classList.remove('text-sky-600', 'font-semibold', 'text-slate-300');

          if (checked) {
            label.classList.add('text-sky-600', 'font-semibold');
          } else {
            label.classList.add('text-slate-300');
          }
        });
      }

      function highlightSelectedDate() {
        const dateKey = getDateKey(selectedDate);
        const cells = calendarGrid.querySelectorAll('.day-cell');
        cells.forEach(cell => {
          cell.classList.remove('ring-2', 'ring-sky-400', 'border-sky-400', 'bg-sky-50');
          if (cell.dataset.date === dateKey) {
            cell.classList.add('ring-2', 'ring-sky-400', 'border-sky-400', 'bg-sky-50');
          }
        });
      }

      function updateDetailPanel() {
        const dateKey = getDateKey(selectedDate);
        const dayData = getDayData(dateKey);

        selectedDateLabel.textContent = formatJapaneseDate(selectedDate);

        // 朝
        morningCheckbox.checked = dayData.morning.checked;
        if (dayData.morning.checked && dayData.morning.time) {
          morningTimeContainer.classList.remove('hidden');
          morningTimeSpan.textContent = dayData.morning.time;
        } else {
          morningTimeContainer.classList.add('hidden');
          morningTimeSpan.textContent = '';
        }

        // 昼
        noonCheckbox.checked = dayData.noon.checked;
        if (dayData.noon.checked && dayData.noon.time) {
          noonTimeContainer.classList.remove('hidden');
          noonTimeSpan.textContent = dayData.noon.time;
        } else {
          noonTimeContainer.classList.add('hidden');
          noonTimeSpan.textContent = '';
        }

        // 晩
        eveningCheckbox.checked = dayData.evening.checked;
        if (dayData.evening.checked && dayData.evening.time) {
          eveningTimeContainer.classList.remove('hidden');
          eveningTimeSpan.textContent = dayData.evening.time;
        } else {
          eveningTimeContainer.classList.add('hidden');
          eveningTimeSpan.textContent = '';
        }

        applyStatusToDayCell(dateKey);
        highlightSelectedDate();
      }

      function setSelectedDate(dateObj) {
        selectedDate = new Date(
          dateObj.getFullYear(),
          dateObj.getMonth(),
          dateObj.getDate()
        );
        updateDetailPanel();
      }

      function handleCheckboxChange(periodKey) {
        const dateKey = getDateKey(selectedDate);
        const dayData = getDayData(dateKey);

        let checkboxElement;
        let timeContainer;
        let timeSpan;

        if (periodKey === 'morning') {
          checkboxElement = morningCheckbox;
          timeContainer = morningTimeContainer;
          timeSpan = morningTimeSpan;
        } else if (periodKey === 'noon') {
          checkboxElement = noonCheckbox;
          timeContainer = noonTimeContainer;
          timeSpan = noonTimeSpan;
        } else if (periodKey === 'evening') {
          checkboxElement = eveningCheckbox;
          timeContainer = eveningTimeContainer;
          timeSpan = eveningTimeSpan;
        }

        const isChecked = checkboxElement.checked;

        if (isChecked) {
          const now = new Date();
          const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
          dayData[periodKey].checked = true;
          dayData[periodKey].time = timeStr;
          timeContainer.classList.remove('hidden');
          timeSpan.textContent = timeStr;
        } else {
          dayData[periodKey].checked = false;
          dayData[periodKey].time = null;
          timeContainer.classList.add('hidden');
          timeSpan.textContent = '';
        }

        saveData();
        applyStatusToDayCell(dateKey);
      }

      function init() {
        loadData();

        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
        selectedDate = new Date(currentYear, currentMonth, today.getDate());

        renderCalendar(currentYear, currentMonth);
        updateDetailPanel();

        document.getElementById('prev-month-btn').addEventListener('click', () => {
          currentMonth -= 1;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear -= 1;
          }
          selectedDate = new Date(currentYear, currentMonth, 1);
          renderCalendar(currentYear, currentMonth);
          updateDetailPanel();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
          currentMonth += 1;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear += 1;
          }
          selectedDate = new Date(currentYear, currentMonth, 1);
          renderCalendar(currentYear, currentMonth);
          updateDetailPanel();
        });

        document.getElementById('today-btn').addEventListener('click', () => {
          const now = new Date();
          currentYear = now.getFullYear();
          currentMonth = now.getMonth();
          selectedDate = new Date(currentYear, currentMonth, now.getDate());
          renderCalendar(currentYear, currentMonth);
          updateDetailPanel();
        });

        morningCheckbox.addEventListener('change', () => handleCheckboxChange('morning'));
        noonCheckbox.addEventListener('change', () => handleCheckboxChange('noon'));
        eveningCheckbox.addEventListener('change', () => handleCheckboxChange('evening'));
      }

      init();
    })();
  </script>
</body>
</html>
